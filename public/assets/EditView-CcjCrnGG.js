import{u as $,c as C,b as P}from"./vendor-primevue-CFcGQxZZ.js";import{_ as R,a as U}from"./PageHeader-BJrt0-mI.js";import{u as q,_ as M,i as z}from"./itemStore-CwKPKeHT.js";import{r as u,D as A,w as G,o as H,h as D,j as n,x as p,e as N,t as S,v as W,A as J,a1 as K,W as Q,f as k,n as X}from"./vendor-vue-6-0MiUoZ.js";import{_ as Y,u as Z,V as ee}from"./index-ggOyftwP.js";const ae={class:"edit-view"},te={class:"max-w-4xl mx-auto p-6"},se={key:0},oe={key:1,class:"bg-red-50 border border-red-200 rounded-lg p-6"},re={class:"flex items-start gap-3"},ie={class:"flex-1"},ne={class:"text-red-800"},le={class:"text-red-700"},de={key:2,class:"relative"},ce={class:"relative z-10 bg-white rounded-lg p-6"},me={__name:"EditView",setup(ue){const{t:f}=Z(),v=K(),h=Q(),V=$(),l=q(),g=u(!0),d=u(""),w=u(!1),c=u(null),_=u({}),x=u(""),I=u(null);u(!1);const L=A(()=>c.value&&I.value&&!g.value&&!d.value),y=async()=>{const e=v.params.id,a=v.params.databaseId;if(e){g.value=!0,d.value="",_.value={};try{let s,i,t;if(a){const[r,o]=await Promise.all([l.fetchItem(e,a),l.fetchDatabaseInfo(a)]);s=r.result||r,i=o?.schema,t=o?.title||"Item"}else{const[r,o]=await Promise.all([l.fetchItem(e,a),l.ensureSchemaLoaded().then(()=>l.schema)]),b=l.getDatabaseInfo();s=r.result||r,i=b?.schema||o,t=b?.title||o?.title||"Item"}if(!i){d.value=f("forms.failed_to_load_schema");return}if(!s){d.value=f("forms.item_not_exist");return}I.value=i,x.value=t;const m=i?.properties?Object.fromEntries(Object.entries(i.properties).map(([r,o])=>{const b=s[r]||"",j={...o,value:b,name:o.name||r,number:o.number||null,select:o.select||null,multi_select:o.multi_select||null,format:o.type==="number"?o.number?.format||o.format:void 0};return console.log(`EditView - Field ${r}:`,{property:o,fieldValue:b,enrichedProperty:j}),[r,j]})):{};c.value=m}catch(s){console.error("Error loading item:",s),d.value=s.message||f("forms.failed_to_load_item")}finally{g.value=!1}}},E=()=>{y()},T=e=>{Object.entries(e).forEach(([a,s])=>{c.value[a]&&(c.value[a].value=s)}),_.value={}},B=async()=>{if(!w.value){w.value=!0;try{_.value={};const e=Object.fromEntries(Object.entries(c.value).map(([m,r])=>[m,r.value])),a=O(e,c.value);if(!a.isValid){_.value=a.errors;return}const s=v.params.id,i=v.params.databaseId;i?await z.updateItem(s,e,I.value,i):await l.updateItem(s,e,I.value),V.add({severity:"success",summary:f("common.success"),detail:f("forms.item_updated_successfully",{item:x.value}),life:3e3});const t=v.params.databaseId;if(t)try{await l.loadDatabase(t,{useCache:!1})}catch(m){console.warn("Background refresh after update failed:",m?.message||m)}await X(),t?h.push({name:"db-list",params:{databaseId:t}}):h.push("/")}catch(e){console.error("Update failed:",e);const a=e?.message||f("forms.failed_to_update_item",{item:x.value.toLowerCase()});V.add({severity:"error",summary:f("common.error"),detail:a,life:5e3})}finally{w.value=!1}}},O=(e,a)=>{const s={properties:Object.fromEntries(Object.entries(a).map(([i,t])=>[i,{type:t.type,required:t.required||!1,number:t.number,options:t.options,minLength:t.minLength,maxLength:t.maxLength}]))};return ee.validateFormData(e,s)},F=()=>{const e=v.params.databaseId;e?h.push({name:"db-list",params:{databaseId:e}}):h.push("/")};return G(()=>v.params.id,(e,a)=>{e&&e!==a&&y()},{immediate:!1}),H(()=>{y()}),(e,a)=>{const s=R,i=M,t=C,m=U,r=P;return k(),D("div",ae,[n("div",te,[p(s,{mode:"edit","database-title":x.value,"show-back-button":!0,onGoBack:F},null,8,["database-title"]),g.value||!c.value&&!d.value?(k(),D("div",se,[p(i,{count:1,"container-class":"bg-white rounded-lg shadow-sm border border-gray-200 p-6"})])):d.value?(k(),D("div",oe,[n("div",re,[a[0]||(a[0]=n("i",{class:"pi pi-exclamation-triangle text-red-500 text-xl mt-1"},null,-1)),n("div",ie,[n("strong",ne,S(e.$t("common.error"))+":",1),n("span",le,S(d.value),1),p(t,{onClick:E,severity:"danger",text:""},{default:W(()=>[J(S(e.$t("forms.try_again")),1)]),_:1})])])])):L.value?(k(),D("div",de,[a[1]||(a[1]=n("div",{class:"absolute inset-0 bg-gradient-to-r from-blue-500 via-purple-500 via-pink-500 to-orange-500 rounded-lg p-0.5 shadow-lg",style:{filter:"drop-shadow(0 10px 25px rgba(0, 144, 247, 0.3)) drop-shadow(0 4px 6px rgba(186, 98, 252, 0.2)) drop-shadow(0 1px 3px rgba(242, 65, 107, 0.2)) drop-shadow(0 0 0 rgba(245, 86, 0, 0.1))"}},[n("div",{class:"bg-white rounded-lg h-full w-full"})],-1)),n("div",ce,[p(m,{"editing-item":c.value,submitting:w.value,"form-errors":_.value,onSubmitForm:B,onRefreshSchema:E,"onUpdate:formData":T,onCancelForm:F},null,8,["editing-item","submitting","form-errors"])])])):N("",!0)]),p(r)])}}},he=Y(me,[["__scopeId","data-v-04b4f31e"]]);export{he as default};
