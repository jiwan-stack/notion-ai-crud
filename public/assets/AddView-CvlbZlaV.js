import{u as R,c as N,b as M}from"./vendor-primevue-CFcGQxZZ.js";import{_ as W,a as q}from"./PageHeader-BKdmJm0D.js";import{u as z,_ as G}from"./itemStore-yywe5r66.js";import{r as h,D as H,o as Z,h as j,x as I,d as J,e as $,j as m,t as T,v as K,A as Q,a1 as X,W as Y,f as x,n as ee}from"./vendor-vue-6-0MiUoZ.js";import{_ as ae,u as te,a as se}from"./index-D43zvyop.js";const oe={class:"add-view"},re={key:1,class:"bg-red-50 border border-red-200 rounded-lg p-6 mb-6"},le={class:"flex items-center"},ie={class:"text-lg font-medium text-red-800"},ne={class:"text-red-700 mt-1"},ce={key:2,class:"relative"},me={class:"relative z-10 rounded-lg p-6"},de={__name:"AddView",setup(ue){const{t:d}=te(),_=Y(),k=X(),S=R(),u=z(),g=h(!0),y=h(!1),p=h(""),n=h(null),v=h({}),b=h(""),i=h(null),O=H(()=>n.value&&i.value&&!g.value&&!p.value),F={email:/^[^\s@]+@[^\s@]+\.[^\s@]+$/,phone:/^[+]?[1-9][\d]{0,15}$/},U=async()=>{g.value=!0,p.value="";try{const a=k.params.databaseId;if(a){const s=se();if(s.databases.length===0)try{await s.fetchDatabases()}catch(w){const P=w.message||"Failed to load databases";throw S.add({severity:"error",summary:d("common.error")||"Error",detail:P.replace(/^Failed to list databases: /,""),life:5e3}),w}const l=s.databases.find(w=>w.id===a),e=await u.fetchDatabaseInfo(a);e?.schema?.properties;let c=null,f=null;e?.schema?.properties&&Object.keys(e.schema.properties).length>0?(c=e.schema,f=e.schema.properties):e?.schema&&typeof e.schema=="object"&&!e.schema.properties?(c=e.schema,f=e.schema):e?.properties&&Object.keys(e.properties).length>0?(c={properties:e.properties},f=e.properties,console.log("Using dbInfo.properties:",f)):e?.schema?.properties&&(console.log("Schema properties exists but is empty:",e.schema.properties),console.log("Schema properties keys:",Object.keys(e.schema.properties)),console.log("Schema properties values:",Object.values(e.schema.properties)),c=e.schema,f=e.schema.properties,console.log("Using empty schema.properties anyway:",f));const C=e?.title||"Item";if(!c||!f){console.error("No valid schema or properties found in database info:",e),p.value=d("forms.failed_to_load_schema");return}i.value=c,b.value=C}else{await u.fetchSchema();const s=u.getDatabaseInfo(),o=s?.schema||u.schema,l=s?.title||u.schema?.title||"Item";if(!o){p.value=d("forms.failed_to_load_schema");return}i.value=o,b.value=l}let t=null;a?i.value?.properties&&Object.keys(i.value.properties).length>0?t=i.value.properties:i.value&&typeof i.value=="object"&&!i.value.properties&&(t=i.value):t=i.value?.properties||i.value;const r=t?Object.fromEntries(Object.entries(t).map(([s,o])=>{const l={...o,value:"",name:o.name||s,number:o.number||null,select:o.select||null,multi_select:o.multi_select||null,format:o.type==="number"?o.number?.format||o.format:void 0};return[s,l]})):{};n.value=r,v.value={},console.log("Item.value keys:",Object.keys(n.value)),console.log("Is form ready?",O.value)}catch(a){console.error("Failed to load database schema:",a),p.value=a.message||"Failed to load database schema"}finally{g.value=!1}},D=async()=>{await U()},E=a=>{Object.entries(a).forEach(([t,r])=>{n.value[t]&&(n.value[t].value=r)}),v.value={}},L=async()=>{if(!y.value){y.value=!0;try{v.value={};const a=Object.fromEntries(Object.entries(n.value).map(([s,o])=>[s,o.value])),t=A(a,n.value);if(!t.isValid){v.value=t.errors;return}const r=k.params.databaseId;r?await u.createItem(a,r):await u.createItem(a),S.add({severity:"success",summary:d("common.success"),detail:d("forms.item_added_successfully",{item:b.value}),life:3e3}),await ee(),r?_.push({name:"db-list",params:{databaseId:r}}):_.push("/")}catch(a){console.error("Create failed:",a);const t=a?.message||d("forms.failed_to_add_item",{item:b.value.toLowerCase()});S.add({severity:"error",summary:d("common.error"),detail:t,life:5e3})}finally{y.value=!1}}},A=(a,t)=>{const r={};return t?(Object.entries(t).forEach(([s,o])=>{const l=a[s],e=l?.toString().trim();if(o.required&&(!l||e==="")){r[s]=`${B(s)} is required`;return}if(l&&e!=="")switch(o.type){case"email":{F.email.test(l)||(r[s]="Please enter a valid email address");break}case"url":{try{new URL(l)}catch{!l.startsWith("http://")&&!l.startsWith("https://")&&(r[s]="Please enter a valid URL (include http:// or https://)")}break}case"phone_number":{const c=l.replace(/[\s\-()]/g,"");F.phone.test(c)||(r[s]="Please enter a valid phone number");break}}}),{isValid:Object.keys(r).length===0,errors:r}):{isValid:!0,errors:{}}},B=a=>a.replace(/([A-Z])/g," $1").replace(/^./,t=>t.toUpperCase()).trim(),V=()=>{const a=k.params.databaseId;a?_.push({name:"db-list",params:{databaseId:a}}):_.push("/")};return Z(()=>{U()}),(a,t)=>{const r=W,s=G,o=N,l=q,e=M;return x(),j("div",oe,[I(r,{mode:"add","database-title":b.value,"show-back-button":!0,onGoBack:V},null,8,["database-title"]),g.value?(x(),J(s,{key:0,count:1})):p.value?(x(),j("div",re,[m("div",le,[t[0]||(t[0]=m("i",{class:"pi pi-exclamation-triangle text-red-500 mr-3 text-xl"},null,-1)),m("div",null,[m("h3",ie,T(a.$t("forms.error_loading_form")),1),m("p",ne,T(p.value),1)])]),I(o,{onClick:D,severity:"danger",class:"mt-4"},{default:K(()=>[Q(T(a.$t("forms.try_again")),1)]),_:1})])):$("",!0),O.value?(x(),j("div",ce,[t[1]||(t[1]=m("div",{class:"absolute inset-0 bg-gradient-to-r from-blue-500 via-purple-500 via-pink-500 to-orange-500 rounded-lg p-0.5 shadow-lg",style:{filter:"drop-shadow(0 10px 25px rgba(0, 144, 247, 0.3)) drop-shadow(0 4px 6px rgba(186, 98, 252, 0.2)) drop-shadow(0 1px 3px rgba(242, 65, 107, 0.2)) drop-shadow(0 0 0 rgba(245, 86, 0, 0.1))"}},[m("div",{class:"bg-white rounded-lg h-full w-full"})],-1)),m("div",me,[I(l,{"editing-item":n.value,submitting:y.value,"form-errors":v.value,onSubmitForm:L,onRefreshSchema:D,"onUpdate:formData":E,onCancelForm:V},null,8,["editing-item","submitting","form-errors"])])])):$("",!0),I(e)])}}},_e=ae(de,[["__scopeId","data-v-06066716"]]);export{_e as default};
